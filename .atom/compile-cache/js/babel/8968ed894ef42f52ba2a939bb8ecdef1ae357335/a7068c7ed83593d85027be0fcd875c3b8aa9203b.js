/**
 * Definition of interactive functions: the function
 * that require additional dialog prompt and update
 * editor content when user types data in prompt
 */
var utils = require('emmet/lib/utils/common');
var editorUtils = require('emmet/lib/utils/editor');
var actionUtils = require('emmet/lib/utils/action');

var range = require('emmet/lib/assets/range');
var htmlMatcher = require('emmet/lib/assets/htmlMatcher');
var parser = require('emmet/lib/parser/abbreviation');
var _updateTag = require('emmet/lib/action/updateTag');

var atom = require('atom');
var PromptView = require('./prompt');
var Point = atom.Point;
var Range = atom.Range;
var prompt = new PromptView();

/**
 * Caches wrapping context for current selection in editor
 * @param  {IEmmetEditor} editor 
 * @param  {Object} info Current editor info (content, syntax, etc.) 
 * @return {Object}
 */
function selectionContext(editor, info) {
	info = info || editorUtils.outputInfo(editor);
	return editor.selectionList().map(function (sel, i) {
		var r = range(sel);
		var tag = htmlMatcher.tag(info.content, r.start);
		if (!r.length() && tag) {
			// no selection, use tag pair
			r = utils.narrowToNonSpace(info.content, tag.range);
		}

		var out = {
			selection: r,
			tag: tag,
			caret: r.start,
			syntax: info.syntax,
			profile: info.profile || null,
			counter: i + 1,
			contextNode: actionUtils.captureContext(editor, r.start)
		};

		if (r.length()) {
			var pasted = utils.escapeText(r.substring(info.content));
			out.pastedContent = editorUtils.unindent(editor, pasted);
		}

		return out;
	});
}

function updateFinalCarets(selCtx, fromIndex, delta) {
	if (!delta) {
		return;
	}

	var offset = new Point(delta, 0);
	for (var i = fromIndex + 1, il = selCtx.length; i < il; i++) {
		selCtx[i].finalCaret = selCtx[i].finalCaret.translate(offset);
	}
}

/**
 * Returns current caret position for given editor
 * @param  {Editor} editor Atom editor instance
 * @return {Number}        Character index in editor
 */
function getCaret(editor) {
	// we canâ€™t use default `getCursor()` method because it returns
	// the most recent (e.g. the latest) caret, but we need the first one
	return editor.getSelectedBufferRanges()[0].start;
}

function lineDelta(prev, cur) {
	return utils.splitByLines(cur).length - utils.splitByLines(prev).length;
}

function setFinalCarets(selCtx, editor) {
	if (selCtx && selCtx.length > 1) {
		editor.setSelectedBufferRanges(selCtx.map(function (ctx) {
			return new Range(ctx.finalCaret, ctx.finalCaret);
		}));
	}
}

module.exports = {
	run: function run(cmd, editor) {
		if (cmd === 'wrap_with_abbreviation') {
			return this.wrapWithAbbreviation(editor);
		}

		if (cmd === 'update_tag') {
			return this.updateTag(editor);
		}

		if (cmd === 'interactive_expand_abbreviation') {
			return this.expandAbbreviation(editor);
		}
	},

	expandAbbreviation: function expandAbbreviation(editor) {
		var info = editorUtils.outputInfo(editor);
		var selCtx = editor.selectionList().map(function (sel, i) {
			editor._selection.index = i;
			var r = range(sel);
			return {
				selection: r,
				selectedText: r.substring(info.content),
				caret: r.start,
				syntax: info.syntax,
				profile: info.profile || null,
				counter: i + 1,
				contextNode: actionUtils.captureContext(editor, r.start)
			};
		});

		return this.wrapWithAbbreviation(editor, selCtx);
	},

	wrapWithAbbreviation: function wrapWithAbbreviation(editor, selCtx) {
		selCtx = selCtx || selectionContext(editor);

		// show prompt dialog that will wrap each selection
		// on user typing
		prompt.show({
			label: 'Enter Abbreviation',
			editor: editor.editor,
			editorView: editor.editorView,
			update: function update(abbr) {
				var result, replaced;
				for (var i = selCtx.length - 1, ctx; i >= 0; i--) {
					ctx = selCtx[i];
					result = '';
					try {
						if (abbr) {
							result = parser.expand(abbr, ctx);
						} else {
							result = ctx.pastedContent;
						}
					} catch (e) {
						console.error(e);
						result = ctx.pastedContent;
					}

					editor._selection.index = i;
					replaced = editor.replaceContent(result, ctx.selection.start, ctx.selection.end);
					ctx.finalCaret = getCaret(editor.editor);
					updateFinalCarets(selCtx, i, lineDelta(ctx.selectedText, replaced));
				}
			},
			confirm: function confirm() {
				setFinalCarets(selCtx, editor.editor);
			}
		});
	},

	updateTag: function updateTag(editor) {
		var info = editorUtils.outputInfo(editor);
		var selCtx = selectionContext(editor, info);

		// show prompt dialog that will update each
		// tag from selection
		prompt.show({
			label: 'Enter Abbreviation',
			editor: editor.editor,
			editorView: editor.editorView,
			update: function update(abbr) {
				var tag, replaced, delta;
				for (var i = selCtx.length - 1, ctx; i >= 0; i--) {
					ctx = selCtx[i];
					tag = null;

					try {
						tag = _updateTag.getUpdatedTag(abbr, { match: ctx.tag }, info.content, {
							counter: ctx.counter
						});
					} catch (e) {
						console.error(e);
					}

					if (!tag) {
						continue;
					}

					replaced = [{
						start: ctx.tag.open.range.start,
						end: ctx.tag.open.range.end,
						content: tag.source
					}];

					if (tag.name() != ctx.tag.name && ctx.tag.close) {
						replaced.unshift({
							start: ctx.tag.close.range.start,
							end: ctx.tag.close.range.end,
							content: '</' + tag.name() + '>'
						});
					}

					replaced.forEach(function (data) {
						editor.replaceContent(data.content, data.start, data.end);
						ctx.finalCaret = editor.editor.getBuffer().positionForCharacterIndex(data.start);
					});
				}
			},
			confirm: function confirm() {
				setFinalCarets(selCtx, editor.editor);
			}
		});
	}
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9yd2FybmVyL0Ryb3Bib3gvY29uZmlnLy5hdG9tL3BhY2thZ2VzL2VtbWV0L2xpYi9pbnRlcmFjdGl2ZS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUtBLElBQUksS0FBSyxHQUFTLE9BQU8sQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO0FBQ3BELElBQUksV0FBVyxHQUFHLE9BQU8sQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO0FBQ3BELElBQUksV0FBVyxHQUFHLE9BQU8sQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDOztBQUVwRCxJQUFJLEtBQUssR0FBUyxPQUFPLENBQUMsd0JBQXdCLENBQUMsQ0FBQztBQUNwRCxJQUFJLFdBQVcsR0FBRyxPQUFPLENBQUMsOEJBQThCLENBQUMsQ0FBQztBQUMxRCxJQUFJLE1BQU0sR0FBUSxPQUFPLENBQUMsK0JBQStCLENBQUMsQ0FBQztBQUMzRCxJQUFJLFVBQVMsR0FBSyxPQUFPLENBQUMsNEJBQTRCLENBQUMsQ0FBQzs7QUFFeEQsSUFBSSxJQUFJLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQzNCLElBQUksVUFBVSxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUNyQyxJQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO0FBQ3ZCLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7QUFDdkIsSUFBSSxNQUFNLEdBQUcsSUFBSSxVQUFVLEVBQUUsQ0FBQzs7Ozs7Ozs7QUFROUIsU0FBUyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsSUFBSSxFQUFFO0FBQ3ZDLEtBQUksR0FBRyxJQUFJLElBQUksV0FBVyxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUM5QyxRQUFPLE1BQU0sQ0FBQyxhQUFhLEVBQUUsQ0FBQyxHQUFHLENBQUMsVUFBUyxHQUFHLEVBQUUsQ0FBQyxFQUFFO0FBQ2xELE1BQUksQ0FBQyxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUMs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b20vcGFja2FnZXMvZW1tZXQvbGliL2ludGVyYWN0aXZlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBEZWZpbml0aW9uIG9mIGludGVyYWN0aXZlIGZ1bmN0aW9uczogdGhlIGZ1bmN0aW9uXG4gKiB0aGF0IHJlcXVpcmUgYWRkaXRpb25hbCBkaWFsb2cgcHJvbXB0IGFuZCB1cGRhdGVcbiAqIGVkaXRvciBjb250ZW50IHdoZW4gdXNlciB0eXBlcyBkYXRhIGluIHByb21wdFxuICovXG52YXIgdXRpbHMgICAgICAgPSByZXF1aXJlKCdlbW1ldC9saWIvdXRpbHMvY29tbW9uJyk7XG52YXIgZWRpdG9yVXRpbHMgPSByZXF1aXJlKCdlbW1ldC9saWIvdXRpbHMvZWRpdG9yJyk7XG52YXIgYWN0aW9uVXRpbHMgPSByZXF1aXJlKCdlbW1ldC9saWIvdXRpbHMvYWN0aW9uJyk7XG5cbnZhciByYW5nZSAgICAgICA9IHJlcXVpcmUoJ2VtbWV0L2xpYi9hc3NldHMvcmFuZ2UnKTtcbnZhciBodG1sTWF0Y2hlciA9IHJlcXVpcmUoJ2VtbWV0L2xpYi9hc3NldHMvaHRtbE1hdGNoZXInKTtcbnZhciBwYXJzZXIgICAgICA9IHJlcXVpcmUoJ2VtbWV0L2xpYi9wYXJzZXIvYWJicmV2aWF0aW9uJyk7XG52YXIgdXBkYXRlVGFnICAgPSByZXF1aXJlKCdlbW1ldC9saWIvYWN0aW9uL3VwZGF0ZVRhZycpO1xuXG52YXIgYXRvbSA9IHJlcXVpcmUoJ2F0b20nKTtcbnZhciBQcm9tcHRWaWV3ID0gcmVxdWlyZSgnLi9wcm9tcHQnKTtcbnZhciBQb2ludCA9IGF0b20uUG9pbnQ7XG52YXIgUmFuZ2UgPSBhdG9tLlJhbmdlO1xudmFyIHByb21wdCA9IG5ldyBQcm9tcHRWaWV3KCk7XG5cbi8qKlxuICogQ2FjaGVzIHdyYXBwaW5nIGNvbnRleHQgZm9yIGN1cnJlbnQgc2VsZWN0aW9uIGluIGVkaXRvclxuICogQHBhcmFtICB7SUVtbWV0RWRpdG9yfSBlZGl0b3IgXG4gKiBAcGFyYW0gIHtPYmplY3R9IGluZm8gQ3VycmVudCBlZGl0b3IgaW5mbyAoY29udGVudCwgc3ludGF4LCBldGMuKSBcbiAqIEByZXR1cm4ge09iamVjdH1cbiAqL1xuZnVuY3Rpb24gc2VsZWN0aW9uQ29udGV4dChlZGl0b3IsIGluZm8pIHtcblx0aW5mbyA9IGluZm8gfHwgZWRpdG9yVXRpbHMub3V0cHV0SW5mbyhlZGl0b3IpO1xuXHRyZXR1cm4gZWRpdG9yLnNlbGVjdGlvbkxpc3QoKS5tYXAoZnVuY3Rpb24oc2VsLCBpKSB7XG5cdFx0dmFyIHIgPSByYW5nZShzZWwpO1xuXHRcdHZhciB0YWcgPSBodG1sTWF0Y2hlci50YWcoaW5mby5jb250ZW50LCByLnN0YXJ0KTtcblx0XHRpZiAoIXIubGVuZ3RoKCkgJiYgdGFnKSB7XG5cdFx0XHQvLyBubyBzZWxlY3Rpb24sIHVzZSB0YWcgcGFpclxuXHRcdFx0ciA9IHV0aWxzLm5hcnJvd1RvTm9uU3BhY2UoaW5mby5jb250ZW50LCB0YWcucmFuZ2UpO1xuXHRcdH1cblxuXHRcdHZhciBvdXQgPSB7XG5cdFx0XHRzZWxlY3Rpb246IHIsXG5cdFx0XHR0YWc6IHRhZyxcblx0XHRcdGNhcmV0OiByLnN0YXJ0LFxuXHRcdFx0c3ludGF4OiBpbmZvLnN5bnRheCxcblx0XHRcdHByb2ZpbGU6IGluZm8ucHJvZmlsZSB8fCBudWxsLFxuXHRcdFx0Y291bnRlcjogaSArIDEsXG5cdFx0XHRjb250ZXh0Tm9kZTogYWN0aW9uVXRpbHMuY2FwdHVyZUNvbnRleHQoZWRpdG9yLCByLnN0YXJ0KVxuXHRcdH07XG5cblx0XHRpZiAoci5sZW5ndGgoKSkge1xuXHRcdFx0dmFyIHBhc3RlZCA9IHV0aWxzLmVzY2FwZVRleHQoci5zdWJzdHJpbmcoaW5mby5jb250ZW50KSk7XG5cdFx0XHRvdXQucGFzdGVkQ29udGVudCA9IGVkaXRvclV0aWxzLnVuaW5kZW50KGVkaXRvciwgcGFzdGVkKTtcblx0XHR9XG5cblx0XHRyZXR1cm4gb3V0O1xuXHR9KTtcbn1cblxuZnVuY3Rpb24gdXBkYXRlRmluYWxDYXJldHMoc2VsQ3R4LCBmcm9tSW5kZXgsIGRlbHRhKSB7XG5cdGlmICghZGVsdGEpIHtcblx0XHRyZXR1cm47XG5cdH1cblxuXHR2YXIgb2Zmc2V0ID0gbmV3IFBvaW50KGRlbHRhLCAwKTtcblx0Zm9yICh2YXIgaSA9IGZyb21JbmRleCArIDEsIGlsID0gc2VsQ3R4Lmxlbmd0aDsgaSA8IGlsOyBpKyspIHtcblx0XHRzZWxDdHhbaV0uZmluYWxDYXJldCA9IHNlbEN0eFtpXS5maW5hbENhcmV0LnRyYW5zbGF0ZShvZmZzZXQpO1xuXHR9XG59XG5cbi8qKlxuICogUmV0dXJucyBjdXJyZW50IGNhcmV0IHBvc2l0aW9uIGZvciBnaXZlbiBlZGl0b3JcbiAqIEBwYXJhbSAge0VkaXRvcn0gZWRpdG9yIEF0b20gZWRpdG9yIGluc3RhbmNlXG4gKiBAcmV0dXJuIHtOdW1iZXJ9ICAgICAgICBDaGFyYWN0ZXIgaW5kZXggaW4gZWRpdG9yXG4gKi9cbmZ1bmN0aW9uIGdldENhcmV0KGVkaXRvcikge1xuXHQvLyB3ZSBjYW7igJl0IHVzZSBkZWZhdWx0IGBnZXRDdXJzb3IoKWAgbWV0aG9kIGJlY2F1c2UgaXQgcmV0dXJuc1xuXHQvLyB0aGUgbW9zdCByZWNlbnQgKGUuZy4gdGhlIGxhdGVzdCkgY2FyZXQsIGJ1dCB3ZSBuZWVkIHRoZSBmaXJzdCBvbmVcblx0cmV0dXJuIGVkaXRvci5nZXRTZWxlY3RlZEJ1ZmZlclJhbmdlcygpWzBdLnN0YXJ0O1xufVxuXG5mdW5jdGlvbiBsaW5lRGVsdGEocHJldiwgY3VyKSB7XG5cdHJldHVybiB1dGlscy5zcGxpdEJ5TGluZXMoY3VyKS5sZW5ndGggLSB1dGlscy5zcGxpdEJ5TGluZXMocHJldikubGVuZ3RoO1xufVxuXG5mdW5jdGlvbiBzZXRGaW5hbENhcmV0cyhzZWxDdHgsIGVkaXRvcikge1xuXHRpZiAoc2VsQ3R4ICYmIHNlbEN0eC5sZW5ndGggPiAxKSB7XG5cdFx0ZWRpdG9yLnNldFNlbGVjdGVkQnVmZmVyUmFuZ2VzKHNlbEN0eC5tYXAoZnVuY3Rpb24oY3R4KSB7XG5cdFx0XHRyZXR1cm4gbmV3IFJhbmdlKGN0eC5maW5hbENhcmV0LCBjdHguZmluYWxDYXJldCk7XG5cdFx0fSkpO1xuXHR9XG59XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuXHRydW46IGZ1bmN0aW9uKGNtZCwgZWRpdG9yKSB7XG5cdFx0aWYgKGNtZCA9PT0gJ3dyYXBfd2l0aF9hYmJyZXZpYXRpb24nKSB7XG5cdFx0XHRyZXR1cm4gdGhpcy53cmFwV2l0aEFiYnJldmlhdGlvbihlZGl0b3IpO1xuXHRcdH1cblxuXHRcdGlmIChjbWQgPT09ICd1cGRhdGVfdGFnJykge1xuXHRcdFx0cmV0dXJuIHRoaXMudXBkYXRlVGFnKGVkaXRvcik7XG5cdFx0fVxuXG5cdFx0aWYgKGNtZCA9PT0gJ2ludGVyYWN0aXZlX2V4cGFuZF9hYmJyZXZpYXRpb24nKSB7XG5cdFx0XHRyZXR1cm4gdGhpcy5leHBhbmRBYmJyZXZpYXRpb24oZWRpdG9yKTtcblx0XHR9XG5cdH0sXG5cblx0ZXhwYW5kQWJicmV2aWF0aW9uOiBmdW5jdGlvbihlZGl0b3IpIHtcblx0XHR2YXIgaW5mbyA9IGVkaXRvclV0aWxzLm91dHB1dEluZm8oZWRpdG9yKTtcblx0XHR2YXIgc2VsQ3R4ID0gZWRpdG9yLnNlbGVjdGlvbkxpc3QoKS5tYXAoZnVuY3Rpb24oc2VsLCBpKSB7XG5cdFx0XHRlZGl0b3IuX3NlbGVjdGlvbi5pbmRleCA9IGk7XG5cdFx0XHR2YXIgciA9IHJhbmdlKHNlbCk7XG5cdFx0XHRyZXR1cm4ge1xuXHRcdFx0XHRzZWxlY3Rpb246IHIsXG5cdFx0XHRcdHNlbGVjdGVkVGV4dDogci5zdWJzdHJpbmcoaW5mby5jb250ZW50KSxcblx0XHRcdFx0Y2FyZXQ6IHIuc3RhcnQsXG5cdFx0XHRcdHN5bnRheDogaW5mby5zeW50YXgsXG5cdFx0XHRcdHByb2ZpbGU6IGluZm8ucHJvZmlsZSB8fCBudWxsLFxuXHRcdFx0XHRjb3VudGVyOiBpICsgMSxcblx0XHRcdFx0Y29udGV4dE5vZGU6IGFjdGlvblV0aWxzLmNhcHR1cmVDb250ZXh0KGVkaXRvciwgci5zdGFydClcblx0XHRcdH07XG5cdFx0fSk7XG5cblx0XHRyZXR1cm4gdGhpcy53cmFwV2l0aEFiYnJldmlhdGlvbihlZGl0b3IsIHNlbEN0eCk7XG5cdH0sXG5cblx0d3JhcFdpdGhBYmJyZXZpYXRpb246IGZ1bmN0aW9uKGVkaXRvciwgc2VsQ3R4KSB7XG5cdFx0c2VsQ3R4ID0gc2VsQ3R4IHx8IHNlbGVjdGlvbkNvbnRleHQoZWRpdG9yKTtcblxuXHRcdC8vIHNob3cgcHJvbXB0IGRpYWxvZyB0aGF0IHdpbGwgd3JhcCBlYWNoIHNlbGVjdGlvblxuXHRcdC8vIG9uIHVzZXIgdHlwaW5nXG5cdFx0cHJvbXB0LnNob3coe1xuXHRcdFx0bGFiZWw6ICdFbnRlciBBYmJyZXZpYXRpb24nLFxuXHRcdFx0ZWRpdG9yOiBlZGl0b3IuZWRpdG9yLFxuXHRcdFx0ZWRpdG9yVmlldzogZWRpdG9yLmVkaXRvclZpZXcsXG5cdFx0XHR1cGRhdGU6IGZ1bmN0aW9uKGFiYnIpIHtcblx0XHRcdFx0dmFyIHJlc3VsdCwgcmVwbGFjZWQ7XG5cdFx0XHRcdGZvciAodmFyIGkgPSBzZWxDdHgubGVuZ3RoIC0gMSwgY3R4OyBpID49IDA7IGktLSkge1xuXHRcdFx0XHRcdGN0eCA9IHNlbEN0eFtpXTtcblx0XHRcdFx0XHRyZXN1bHQgPSAnJztcblx0XHRcdFx0XHR0cnkge1xuXHRcdFx0XHRcdFx0aWYgKGFiYnIpIHtcblx0XHRcdFx0XHRcdFx0cmVzdWx0ID0gcGFyc2VyLmV4cGFuZChhYmJyLCBjdHgpO1xuXHRcdFx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRcdFx0cmVzdWx0ID0gY3R4LnBhc3RlZENvbnRlbnQ7XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0fSBjYXRjaCAoZSkge1xuXHRcdFx0XHRcdFx0Y29uc29sZS5lcnJvcihlKTtcblx0XHRcdFx0XHRcdHJlc3VsdCA9IGN0eC5wYXN0ZWRDb250ZW50O1xuXHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdGVkaXRvci5fc2VsZWN0aW9uLmluZGV4ID0gaTtcblx0XHRcdFx0XHRyZXBsYWNlZCA9IGVkaXRvci5yZXBsYWNlQ29udGVudChyZXN1bHQsIGN0eC5zZWxlY3Rpb24uc3RhcnQsIGN0eC5zZWxlY3Rpb24uZW5kKTtcblx0XHRcdFx0XHRjdHguZmluYWxDYXJldCA9IGdldENhcmV0KGVkaXRvci5lZGl0b3IpO1xuXHRcdFx0XHRcdHVwZGF0ZUZpbmFsQ2FyZXRzKHNlbEN0eCwgaSwgbGluZURlbHRhKGN0eC5zZWxlY3RlZFRleHQsIHJlcGxhY2VkKSk7XG5cdFx0XHRcdH1cblx0XHRcdH0sXG5cdFx0XHRjb25maXJtOiBmdW5jdGlvbigpIHtcblx0XHRcdFx0c2V0RmluYWxDYXJldHMoc2VsQ3R4LCBlZGl0b3IuZWRpdG9yKTtcblx0XHRcdH1cblx0XHR9KTtcblx0fSxcblxuXHR1cGRhdGVUYWc6IGZ1bmN0aW9uKGVkaXRvcikge1xuXHRcdHZhciBpbmZvID0gZWRpdG9yVXRpbHMub3V0cHV0SW5mbyhlZGl0b3IpO1xuXHRcdHZhciBzZWxDdHggPSBzZWxlY3Rpb25Db250ZXh0KGVkaXRvciwgaW5mbyk7XG5cblx0XHQvLyBzaG93IHByb21wdCBkaWFsb2cgdGhhdCB3aWxsIHVwZGF0ZSBlYWNoXG5cdFx0Ly8gdGFnIGZyb20gc2VsZWN0aW9uXG5cdFx0cHJvbXB0LnNob3coe1xuXHRcdFx0bGFiZWw6ICdFbnRlciBBYmJyZXZpYXRpb24nLFxuXHRcdFx0ZWRpdG9yOiBlZGl0b3IuZWRpdG9yLFxuXHRcdFx0ZWRpdG9yVmlldzogZWRpdG9yLmVkaXRvclZpZXcsXG5cdFx0XHR1cGRhdGU6IGZ1bmN0aW9uKGFiYnIpIHtcblx0XHRcdFx0dmFyIHRhZywgcmVwbGFjZWQsIGRlbHRhO1xuXHRcdFx0XHRmb3IgKHZhciBpID0gc2VsQ3R4Lmxlbmd0aCAtIDEsIGN0eDsgaSA+PSAwOyBpLS0pIHtcblx0XHRcdFx0XHRjdHggPSBzZWxDdHhbaV07XG5cdFx0XHRcdFx0dGFnID0gbnVsbDtcblxuXHRcdFx0XHRcdHRyeSB7XG5cdFx0XHRcdFx0XHR0YWcgPSB1cGRhdGVUYWcuZ2V0VXBkYXRlZFRhZyhhYmJyLCB7bWF0Y2g6IGN0eC50YWd9LCBpbmZvLmNvbnRlbnQsIHtcblx0XHRcdFx0XHRcdFx0Y291bnRlcjogY3R4LmNvdW50ZXJcblx0XHRcdFx0XHRcdH0pO1xuXHRcdFx0XHRcdH0gY2F0Y2ggKGUpIHtcblx0XHRcdFx0XHRcdGNvbnNvbGUuZXJyb3IoZSk7XG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0aWYgKCF0YWcpIHtcblx0XHRcdFx0XHRcdGNvbnRpbnVlO1xuXHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdHJlcGxhY2VkID0gW3tcblx0XHRcdFx0XHRcdHN0YXJ0OiBjdHgudGFnLm9wZW4ucmFuZ2Uuc3RhcnQsIFxuXHRcdFx0XHRcdFx0ZW5kOiBjdHgudGFnLm9wZW4ucmFuZ2UuZW5kLFxuXHRcdFx0XHRcdFx0Y29udGVudDogdGFnLnNvdXJjZVxuXHRcdFx0XHRcdH1dO1xuXG5cdFx0XHRcdFx0aWYgKHRhZy5uYW1lKCkgIT0gY3R4LnRhZy5uYW1lICYmIGN0eC50YWcuY2xvc2UpIHtcblx0XHRcdFx0XHRcdHJlcGxhY2VkLnVuc2hpZnQoe1xuXHRcdFx0XHRcdFx0XHRzdGFydDogY3R4LnRhZy5jbG9zZS5yYW5nZS5zdGFydCwgXG5cdFx0XHRcdFx0XHRcdGVuZDogY3R4LnRhZy5jbG9zZS5yYW5nZS5lbmQsXG5cdFx0XHRcdFx0XHRcdGNvbnRlbnQ6ICc8LycgKyB0YWcubmFtZSgpICsgJz4nXG5cdFx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRyZXBsYWNlZC5mb3JFYWNoKGZ1bmN0aW9uKGRhdGEpIHtcblx0XHRcdFx0XHRcdGVkaXRvci5yZXBsYWNlQ29udGVudChkYXRhLmNvbnRlbnQsIGRhdGEuc3RhcnQsIGRhdGEuZW5kKTtcblx0XHRcdFx0XHRcdGN0eC5maW5hbENhcmV0ID0gZWRpdG9yLmVkaXRvci5nZXRCdWZmZXIoKS5wb3NpdGlvbkZvckNoYXJhY3RlckluZGV4KGRhdGEuc3RhcnQpO1xuXHRcdFx0XHRcdH0pO1xuXHRcdFx0XHR9XG5cblx0XHRcdH0sXG5cdFx0XHRjb25maXJtOiBmdW5jdGlvbigpIHtcblx0XHRcdFx0c2V0RmluYWxDYXJldHMoc2VsQ3R4LCBlZGl0b3IuZWRpdG9yKTtcblx0XHRcdH1cblx0XHR9KTtcblx0fVxufTsiXX0=