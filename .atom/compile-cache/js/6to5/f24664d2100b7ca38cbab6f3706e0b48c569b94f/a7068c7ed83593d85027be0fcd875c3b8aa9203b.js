/**
 * Definition of interactive functions: the function
 * that require additional dialog prompt and update
 * editor content when user types data in prompt
 */
var utils = require("emmet/lib/utils/common");
var editorUtils = require("emmet/lib/utils/editor");
var actionUtils = require("emmet/lib/utils/action");

var range = require("emmet/lib/assets/range");
var htmlMatcher = require("emmet/lib/assets/htmlMatcher");
var parser = require("emmet/lib/parser/abbreviation");
var updateTag = require("emmet/lib/action/updateTag");

var atom = require("atom");
var PromptView = require("./prompt");
var Point = atom.Point;
var Range = atom.Range;
var prompt = new PromptView();

/**
 * Caches wrapping context for current selection in editor
 * @param  {IEmmetEditor} editor 
 * @param  {Object} info Current editor info (content, syntax, etc.) 
 * @return {Object}
 */
function selectionContext(editor, info) {
	info = info || editorUtils.outputInfo(editor);
	return editor.selectionList().map(function (sel, i) {
		var r = range(sel);
		var tag = htmlMatcher.tag(info.content, r.start);
		if (!r.length() && tag) {
			// no selection, use tag pair
			r = utils.narrowToNonSpace(info.content, tag.range);
		}

		var out = {
			selection: r,
			tag: tag,
			caret: r.start,
			syntax: info.syntax,
			profile: info.profile || null,
			counter: i + 1,
			contextNode: actionUtils.captureContext(editor, r.start)
		};

		if (r.length()) {
			var pasted = utils.escapeText(r.substring(info.content));
			out.pastedContent = editorUtils.unindent(editor, pasted);
		}

		return out;
	});
}

function updateFinalCarets(selCtx, fromIndex, delta) {
	if (!delta) {
		return;
	}

	var offset = new Point(delta, 0);
	for (var i = fromIndex + 1, il = selCtx.length; i < il; i++) {
		selCtx[i].finalCaret = selCtx[i].finalCaret.translate(offset);
	}
}

/**
 * Returns current caret position for given editor
 * @param  {Editor} editor Atom editor instance
 * @return {Number}        Character index in editor
 */
function getCaret(editor) {
	// we canâ€™t use default `getCursor()` method because it returns
	// the most recent (e.g. the latest) caret, but we need the first one
	return editor.getSelectedBufferRanges()[0].start;
}

function lineDelta(prev, cur) {
	return utils.splitByLines(cur).length - utils.splitByLines(prev).length;
}

function setFinalCarets(selCtx, editor) {
	if (selCtx && selCtx.length > 1) {
		editor.setSelectedBufferRanges(selCtx.map(function (ctx) {
			return new Range(ctx.finalCaret, ctx.finalCaret);
		}));
	}
}

module.exports = {
	run: function (cmd, editor) {
		if (cmd === "wrap_with_abbreviation") {
			return this.wrapWithAbbreviation(editor);
		}

		if (cmd === "update_tag") {
			return this.updateTag(editor);
		}

		if (cmd === "interactive_expand_abbreviation") {
			return this.expandAbbreviation(editor);
		}
	},

	expandAbbreviation: function (editor) {
		var info = editorUtils.outputInfo(editor);
		var selCtx = editor.selectionList().map(function (sel, i) {
			editor._selection.index = i;
			var r = range(sel);
			return {
				selection: r,
				selectedText: r.substring(info.content),
				caret: r.start,
				syntax: info.syntax,
				profile: info.profile || null,
				counter: i + 1,
				contextNode: actionUtils.captureContext(editor, r.start)
			};
		});

		return this.wrapWithAbbreviation(editor, selCtx);
	},

	wrapWithAbbreviation: function (editor, selCtx) {
		selCtx = selCtx || selectionContext(editor);

		// show prompt dialog that will wrap each selection
		// on user typing
		prompt.show({
			label: "Enter Abbreviation",
			editor: editor.editor,
			editorView: editor.editorView,
			update: function (abbr) {
				var result, replaced;
				for (var i = selCtx.length - 1, ctx; i >= 0; i--) {
					ctx = selCtx[i];
					result = "";
					try {
						if (abbr) {
							result = parser.expand(abbr, ctx);
						} else {
							result = ctx.pastedContent;
						}
					} catch (e) {
						console.error(e);
						result = ctx.pastedContent;
					}

					editor._selection.index = i;
					replaced = editor.replaceContent(result, ctx.selection.start, ctx.selection.end);
					ctx.finalCaret = getCaret(editor.editor);
					updateFinalCarets(selCtx, i, lineDelta(ctx.selectedText, replaced));
				}
			},
			confirm: function () {
				setFinalCarets(selCtx, editor.editor);
			}
		});
	},

	updateTag: function (editor) {
		var info = editorUtils.outputInfo(editor);
		var selCtx = selectionContext(editor, info);

		// show prompt dialog that will update each
		// tag from selection
		prompt.show({
			label: "Enter Abbreviation",
			editor: editor.editor,
			editorView: editor.editorView,
			update: function (abbr) {
				var tag, replaced, delta;
				for (var i = selCtx.length - 1, ctx; i >= 0; i--) {
					ctx = selCtx[i];
					tag = null;

					try {
						tag = updateTag.getUpdatedTag(abbr, { match: ctx.tag }, info.content, {
							counter: ctx.counter
						});
					} catch (e) {
						console.error(e);
					}

					if (!tag) {
						continue;
					}

					replaced = [{
						start: ctx.tag.open.range.start,
						end: ctx.tag.open.range.end,
						content: tag.source
					}];

					if (tag.name() != ctx.tag.name && ctx.tag.close) {
						replaced.unshift({
							start: ctx.tag.close.range.start,
							end: ctx.tag.close.range.end,
							content: "</" + tag.name() + ">"
						});
					}

					replaced.forEach(function (data) {
						editor.replaceContent(data.content, data.start, data.end);
						ctx.finalCaret = editor.editor.getBuffer().positionForCharacterIndex(data.start);
					});
				}
			},
			confirm: function () {
				setFinalCarets(selCtx, editor.editor);
			}
		});
	}
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9yd2FybmVyL0Ryb3Bib3gvY29uZmlnLy5hdG9tL3BhY2thZ2VzL2VtbWV0L2xpYi9pbnRlcmFjdGl2ZS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUtBLElBQUksS0FBSyxHQUFTLE9BQU8sQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO0FBQ3BELElBQUksV0FBVyxHQUFHLE9BQU8sQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO0FBQ3BELElBQUksV0FBVyxHQUFHLE9BQU8sQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDOztBQUVwRCxJQUFJLEtBQUssR0FBUyxPQUFPLENBQUMsd0JBQXdCLENBQUMsQ0FBQztBQUNwRCxJQUFJLFdBQVcsR0FBRyxPQUFPLENBQUMsOEJBQThCLENBQUMsQ0FBQztBQUMxRCxJQUFJLE1BQU0sR0FBUSxPQUFPLENBQUMsK0JBQStCLENBQUMsQ0FBQztBQUMzRCxJQUFJLFNBQVMsR0FBSyxPQUFPLENBQUMsNEJBQTRCLENBQUMsQ0FBQzs7QUFFeEQsSUFBSSxJQUFJLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQzNCLElBQUksVUFBVSxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUNyQyxJQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO0FBQ3ZCLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7QUFDdkIsSUFBSSxNQUFNLEdBQUcsSUFBSSxVQUFVLEVBQUUsQ0FBQzs7Ozs7Ozs7QUFROUIsU0FBUyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsSUFBSSxFQUFFO0FBQ3ZDLEtBQUksR0FBRyxJQUFJLElBQUksV0FBVyxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUM5QyxRQUFPLE1BQU0sQ0FBQyxhQUFhLEVBQUUsQ0FBQyxHQUFHLENBQUMsVUFBUyxHQUFHLEVBQUUsQ0FBQyxFQUFFO0FBQ2xELE1BQUksQ0FBQyxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUMs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YWdlcy9lbW1ldC9saWIvaW50ZXJhY3RpdmUuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIERlZmluaXRpb24gb2YgaW50ZXJhY3RpdmUgZnVuY3Rpb25zOiB0aGUgZnVuY3Rpb25cbiAqIHRoYXQgcmVxdWlyZSBhZGRpdGlvbmFsIGRpYWxvZyBwcm9tcHQgYW5kIHVwZGF0ZVxuICogZWRpdG9yIGNvbnRlbnQgd2hlbiB1c2VyIHR5cGVzIGRhdGEgaW4gcHJvbXB0XG4gKi9cbnZhciB1dGlscyAgICAgICA9IHJlcXVpcmUoJ2VtbWV0L2xpYi91dGlscy9jb21tb24nKTtcbnZhciBlZGl0b3JVdGlscyA9IHJlcXVpcmUoJ2VtbWV0L2xpYi91dGlscy9lZGl0b3InKTtcbnZhciBhY3Rpb25VdGlscyA9IHJlcXVpcmUoJ2VtbWV0L2xpYi91dGlscy9hY3Rpb24nKTtcblxudmFyIHJhbmdlICAgICAgID0gcmVxdWlyZSgnZW1tZXQvbGliL2Fzc2V0cy9yYW5nZScpO1xudmFyIGh0bWxNYXRjaGVyID0gcmVxdWlyZSgnZW1tZXQvbGliL2Fzc2V0cy9odG1sTWF0Y2hlcicpO1xudmFyIHBhcnNlciAgICAgID0gcmVxdWlyZSgnZW1tZXQvbGliL3BhcnNlci9hYmJyZXZpYXRpb24nKTtcbnZhciB1cGRhdGVUYWcgICA9IHJlcXVpcmUoJ2VtbWV0L2xpYi9hY3Rpb24vdXBkYXRlVGFnJyk7XG5cbnZhciBhdG9tID0gcmVxdWlyZSgnYXRvbScpO1xudmFyIFByb21wdFZpZXcgPSByZXF1aXJlKCcuL3Byb21wdCcpO1xudmFyIFBvaW50ID0gYXRvbS5Qb2ludDtcbnZhciBSYW5nZSA9IGF0b20uUmFuZ2U7XG52YXIgcHJvbXB0ID0gbmV3IFByb21wdFZpZXcoKTtcblxuLyoqXG4gKiBDYWNoZXMgd3JhcHBpbmcgY29udGV4dCBmb3IgY3VycmVudCBzZWxlY3Rpb24gaW4gZWRpdG9yXG4gKiBAcGFyYW0gIHtJRW1tZXRFZGl0b3J9IGVkaXRvciBcbiAqIEBwYXJhbSAge09iamVjdH0gaW5mbyBDdXJyZW50IGVkaXRvciBpbmZvIChjb250ZW50LCBzeW50YXgsIGV0Yy4pIFxuICogQHJldHVybiB7T2JqZWN0fVxuICovXG5mdW5jdGlvbiBzZWxlY3Rpb25Db250ZXh0KGVkaXRvciwgaW5mbykge1xuXHRpbmZvID0gaW5mbyB8fCBlZGl0b3JVdGlscy5vdXRwdXRJbmZvKGVkaXRvcik7XG5cdHJldHVybiBlZGl0b3Iuc2VsZWN0aW9uTGlzdCgpLm1hcChmdW5jdGlvbihzZWwsIGkpIHtcblx0XHR2YXIgciA9IHJhbmdlKHNlbCk7XG5cdFx0dmFyIHRhZyA9IGh0bWxNYXRjaGVyLnRhZyhpbmZvLmNvbnRlbnQsIHIuc3RhcnQpO1xuXHRcdGlmICghci5sZW5ndGgoKSAmJiB0YWcpIHtcblx0XHRcdC8vIG5vIHNlbGVjdGlvbiwgdXNlIHRhZyBwYWlyXG5cdFx0XHRyID0gdXRpbHMubmFycm93VG9Ob25TcGFjZShpbmZvLmNvbnRlbnQsIHRhZy5yYW5nZSk7XG5cdFx0fVxuXG5cdFx0dmFyIG91dCA9IHtcblx0XHRcdHNlbGVjdGlvbjogcixcblx0XHRcdHRhZzogdGFnLFxuXHRcdFx0Y2FyZXQ6IHIuc3RhcnQsXG5cdFx0XHRzeW50YXg6IGluZm8uc3ludGF4LFxuXHRcdFx0cHJvZmlsZTogaW5mby5wcm9maWxlIHx8IG51bGwsXG5cdFx0XHRjb3VudGVyOiBpICsgMSxcblx0XHRcdGNvbnRleHROb2RlOiBhY3Rpb25VdGlscy5jYXB0dXJlQ29udGV4dChlZGl0b3IsIHIuc3RhcnQpXG5cdFx0fTtcblxuXHRcdGlmIChyLmxlbmd0aCgpKSB7XG5cdFx0XHR2YXIgcGFzdGVkID0gdXRpbHMuZXNjYXBlVGV4dChyLnN1YnN0cmluZyhpbmZvLmNvbnRlbnQpKTtcblx0XHRcdG91dC5wYXN0ZWRDb250ZW50ID0gZWRpdG9yVXRpbHMudW5pbmRlbnQoZWRpdG9yLCBwYXN0ZWQpO1xuXHRcdH1cblxuXHRcdHJldHVybiBvdXQ7XG5cdH0pO1xufVxuXG5mdW5jdGlvbiB1cGRhdGVGaW5hbENhcmV0cyhzZWxDdHgsIGZyb21JbmRleCwgZGVsdGEpIHtcblx0aWYgKCFkZWx0YSkge1xuXHRcdHJldHVybjtcblx0fVxuXG5cdHZhciBvZmZzZXQgPSBuZXcgUG9pbnQoZGVsdGEsIDApO1xuXHRmb3IgKHZhciBpID0gZnJvbUluZGV4ICsgMSwgaWwgPSBzZWxDdHgubGVuZ3RoOyBpIDwgaWw7IGkrKykge1xuXHRcdHNlbEN0eFtpXS5maW5hbENhcmV0ID0gc2VsQ3R4W2ldLmZpbmFsQ2FyZXQudHJhbnNsYXRlKG9mZnNldCk7XG5cdH1cbn1cblxuLyoqXG4gKiBSZXR1cm5zIGN1cnJlbnQgY2FyZXQgcG9zaXRpb24gZm9yIGdpdmVuIGVkaXRvclxuICogQHBhcmFtICB7RWRpdG9yfSBlZGl0b3IgQXRvbSBlZGl0b3IgaW5zdGFuY2VcbiAqIEByZXR1cm4ge051bWJlcn0gICAgICAgIENoYXJhY3RlciBpbmRleCBpbiBlZGl0b3JcbiAqL1xuZnVuY3Rpb24gZ2V0Q2FyZXQoZWRpdG9yKSB7XG5cdC8vIHdlIGNhbuKAmXQgdXNlIGRlZmF1bHQgYGdldEN1cnNvcigpYCBtZXRob2QgYmVjYXVzZSBpdCByZXR1cm5zXG5cdC8vIHRoZSBtb3N0IHJlY2VudCAoZS5nLiB0aGUgbGF0ZXN0KSBjYXJldCwgYnV0IHdlIG5lZWQgdGhlIGZpcnN0IG9uZVxuXHRyZXR1cm4gZWRpdG9yLmdldFNlbGVjdGVkQnVmZmVyUmFuZ2VzKClbMF0uc3RhcnQ7XG59XG5cbmZ1bmN0aW9uIGxpbmVEZWx0YShwcmV2LCBjdXIpIHtcblx0cmV0dXJuIHV0aWxzLnNwbGl0QnlMaW5lcyhjdXIpLmxlbmd0aCAtIHV0aWxzLnNwbGl0QnlMaW5lcyhwcmV2KS5sZW5ndGg7XG59XG5cbmZ1bmN0aW9uIHNldEZpbmFsQ2FyZXRzKHNlbEN0eCwgZWRpdG9yKSB7XG5cdGlmIChzZWxDdHggJiYgc2VsQ3R4Lmxlbmd0aCA+IDEpIHtcblx0XHRlZGl0b3Iuc2V0U2VsZWN0ZWRCdWZmZXJSYW5nZXMoc2VsQ3R4Lm1hcChmdW5jdGlvbihjdHgpIHtcblx0XHRcdHJldHVybiBuZXcgUmFuZ2UoY3R4LmZpbmFsQ2FyZXQsIGN0eC5maW5hbENhcmV0KTtcblx0XHR9KSk7XG5cdH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7XG5cdHJ1bjogZnVuY3Rpb24oY21kLCBlZGl0b3IpIHtcblx0XHRpZiAoY21kID09PSAnd3JhcF93aXRoX2FiYnJldmlhdGlvbicpIHtcblx0XHRcdHJldHVybiB0aGlzLndyYXBXaXRoQWJicmV2aWF0aW9uKGVkaXRvcik7XG5cdFx0fVxuXG5cdFx0aWYgKGNtZCA9PT0gJ3VwZGF0ZV90YWcnKSB7XG5cdFx0XHRyZXR1cm4gdGhpcy51cGRhdGVUYWcoZWRpdG9yKTtcblx0XHR9XG5cblx0XHRpZiAoY21kID09PSAnaW50ZXJhY3RpdmVfZXhwYW5kX2FiYnJldmlhdGlvbicpIHtcblx0XHRcdHJldHVybiB0aGlzLmV4cGFuZEFiYnJldmlhdGlvbihlZGl0b3IpO1xuXHRcdH1cblx0fSxcblxuXHRleHBhbmRBYmJyZXZpYXRpb246IGZ1bmN0aW9uKGVkaXRvcikge1xuXHRcdHZhciBpbmZvID0gZWRpdG9yVXRpbHMub3V0cHV0SW5mbyhlZGl0b3IpO1xuXHRcdHZhciBzZWxDdHggPSBlZGl0b3Iuc2VsZWN0aW9uTGlzdCgpLm1hcChmdW5jdGlvbihzZWwsIGkpIHtcblx0XHRcdGVkaXRvci5fc2VsZWN0aW9uLmluZGV4ID0gaTtcblx0XHRcdHZhciByID0gcmFuZ2Uoc2VsKTtcblx0XHRcdHJldHVybiB7XG5cdFx0XHRcdHNlbGVjdGlvbjogcixcblx0XHRcdFx0c2VsZWN0ZWRUZXh0OiByLnN1YnN0cmluZyhpbmZvLmNvbnRlbnQpLFxuXHRcdFx0XHRjYXJldDogci5zdGFydCxcblx0XHRcdFx0c3ludGF4OiBpbmZvLnN5bnRheCxcblx0XHRcdFx0cHJvZmlsZTogaW5mby5wcm9maWxlIHx8IG51bGwsXG5cdFx0XHRcdGNvdW50ZXI6IGkgKyAxLFxuXHRcdFx0XHRjb250ZXh0Tm9kZTogYWN0aW9uVXRpbHMuY2FwdHVyZUNvbnRleHQoZWRpdG9yLCByLnN0YXJ0KVxuXHRcdFx0fTtcblx0XHR9KTtcblxuXHRcdHJldHVybiB0aGlzLndyYXBXaXRoQWJicmV2aWF0aW9uKGVkaXRvciwgc2VsQ3R4KTtcblx0fSxcblxuXHR3cmFwV2l0aEFiYnJldmlhdGlvbjogZnVuY3Rpb24oZWRpdG9yLCBzZWxDdHgpIHtcblx0XHRzZWxDdHggPSBzZWxDdHggfHwgc2VsZWN0aW9uQ29udGV4dChlZGl0b3IpO1xuXG5cdFx0Ly8gc2hvdyBwcm9tcHQgZGlhbG9nIHRoYXQgd2lsbCB3cmFwIGVhY2ggc2VsZWN0aW9uXG5cdFx0Ly8gb24gdXNlciB0eXBpbmdcblx0XHRwcm9tcHQuc2hvdyh7XG5cdFx0XHRsYWJlbDogJ0VudGVyIEFiYnJldmlhdGlvbicsXG5cdFx0XHRlZGl0b3I6IGVkaXRvci5lZGl0b3IsXG5cdFx0XHRlZGl0b3JWaWV3OiBlZGl0b3IuZWRpdG9yVmlldyxcblx0XHRcdHVwZGF0ZTogZnVuY3Rpb24oYWJicikge1xuXHRcdFx0XHR2YXIgcmVzdWx0LCByZXBsYWNlZDtcblx0XHRcdFx0Zm9yICh2YXIgaSA9IHNlbEN0eC5sZW5ndGggLSAxLCBjdHg7IGkgPj0gMDsgaS0tKSB7XG5cdFx0XHRcdFx0Y3R4ID0gc2VsQ3R4W2ldO1xuXHRcdFx0XHRcdHJlc3VsdCA9ICcnO1xuXHRcdFx0XHRcdHRyeSB7XG5cdFx0XHRcdFx0XHRpZiAoYWJicikge1xuXHRcdFx0XHRcdFx0XHRyZXN1bHQgPSBwYXJzZXIuZXhwYW5kKGFiYnIsIGN0eCk7XG5cdFx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0XHRyZXN1bHQgPSBjdHgucGFzdGVkQ29udGVudDtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHR9IGNhdGNoIChlKSB7XG5cdFx0XHRcdFx0XHRjb25zb2xlLmVycm9yKGUpO1xuXHRcdFx0XHRcdFx0cmVzdWx0ID0gY3R4LnBhc3RlZENvbnRlbnQ7XG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0ZWRpdG9yLl9zZWxlY3Rpb24uaW5kZXggPSBpO1xuXHRcdFx0XHRcdHJlcGxhY2VkID0gZWRpdG9yLnJlcGxhY2VDb250ZW50KHJlc3VsdCwgY3R4LnNlbGVjdGlvbi5zdGFydCwgY3R4LnNlbGVjdGlvbi5lbmQpO1xuXHRcdFx0XHRcdGN0eC5maW5hbENhcmV0ID0gZ2V0Q2FyZXQoZWRpdG9yLmVkaXRvcik7XG5cdFx0XHRcdFx0dXBkYXRlRmluYWxDYXJldHMoc2VsQ3R4LCBpLCBsaW5lRGVsdGEoY3R4LnNlbGVjdGVkVGV4dCwgcmVwbGFjZWQpKTtcblx0XHRcdFx0fVxuXHRcdFx0fSxcblx0XHRcdGNvbmZpcm06IGZ1bmN0aW9uKCkge1xuXHRcdFx0XHRzZXRGaW5hbENhcmV0cyhzZWxDdHgsIGVkaXRvci5lZGl0b3IpO1xuXHRcdFx0fVxuXHRcdH0pO1xuXHR9LFxuXG5cdHVwZGF0ZVRhZzogZnVuY3Rpb24oZWRpdG9yKSB7XG5cdFx0dmFyIGluZm8gPSBlZGl0b3JVdGlscy5vdXRwdXRJbmZvKGVkaXRvcik7XG5cdFx0dmFyIHNlbEN0eCA9IHNlbGVjdGlvbkNvbnRleHQoZWRpdG9yLCBpbmZvKTtcblxuXHRcdC8vIHNob3cgcHJvbXB0IGRpYWxvZyB0aGF0IHdpbGwgdXBkYXRlIGVhY2hcblx0XHQvLyB0YWcgZnJvbSBzZWxlY3Rpb25cblx0XHRwcm9tcHQuc2hvdyh7XG5cdFx0XHRsYWJlbDogJ0VudGVyIEFiYnJldmlhdGlvbicsXG5cdFx0XHRlZGl0b3I6IGVkaXRvci5lZGl0b3IsXG5cdFx0XHRlZGl0b3JWaWV3OiBlZGl0b3IuZWRpdG9yVmlldyxcblx0XHRcdHVwZGF0ZTogZnVuY3Rpb24oYWJicikge1xuXHRcdFx0XHR2YXIgdGFnLCByZXBsYWNlZCwgZGVsdGE7XG5cdFx0XHRcdGZvciAodmFyIGkgPSBzZWxDdHgubGVuZ3RoIC0gMSwgY3R4OyBpID49IDA7IGktLSkge1xuXHRcdFx0XHRcdGN0eCA9IHNlbEN0eFtpXTtcblx0XHRcdFx0XHR0YWcgPSBudWxsO1xuXG5cdFx0XHRcdFx0dHJ5IHtcblx0XHRcdFx0XHRcdHRhZyA9IHVwZGF0ZVRhZy5nZXRVcGRhdGVkVGFnKGFiYnIsIHttYXRjaDogY3R4LnRhZ30sIGluZm8uY29udGVudCwge1xuXHRcdFx0XHRcdFx0XHRjb3VudGVyOiBjdHguY291bnRlclxuXHRcdFx0XHRcdFx0fSk7XG5cdFx0XHRcdFx0fSBjYXRjaCAoZSkge1xuXHRcdFx0XHRcdFx0Y29uc29sZS5lcnJvcihlKTtcblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRpZiAoIXRhZykge1xuXHRcdFx0XHRcdFx0Y29udGludWU7XG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0cmVwbGFjZWQgPSBbe1xuXHRcdFx0XHRcdFx0c3RhcnQ6IGN0eC50YWcub3Blbi5yYW5nZS5zdGFydCwgXG5cdFx0XHRcdFx0XHRlbmQ6IGN0eC50YWcub3Blbi5yYW5nZS5lbmQsXG5cdFx0XHRcdFx0XHRjb250ZW50OiB0YWcuc291cmNlXG5cdFx0XHRcdFx0fV07XG5cblx0XHRcdFx0XHRpZiAodGFnLm5hbWUoKSAhPSBjdHgudGFnLm5hbWUgJiYgY3R4LnRhZy5jbG9zZSkge1xuXHRcdFx0XHRcdFx0cmVwbGFjZWQudW5zaGlmdCh7XG5cdFx0XHRcdFx0XHRcdHN0YXJ0OiBjdHgudGFnLmNsb3NlLnJhbmdlLnN0YXJ0LCBcblx0XHRcdFx0XHRcdFx0ZW5kOiBjdHgudGFnLmNsb3NlLnJhbmdlLmVuZCxcblx0XHRcdFx0XHRcdFx0Y29udGVudDogJzwvJyArIHRhZy5uYW1lKCkgKyAnPidcblx0XHRcdFx0XHRcdH0pO1xuXHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdHJlcGxhY2VkLmZvckVhY2goZnVuY3Rpb24oZGF0YSkge1xuXHRcdFx0XHRcdFx0ZWRpdG9yLnJlcGxhY2VDb250ZW50KGRhdGEuY29udGVudCwgZGF0YS5zdGFydCwgZGF0YS5lbmQpO1xuXHRcdFx0XHRcdFx0Y3R4LmZpbmFsQ2FyZXQgPSBlZGl0b3IuZWRpdG9yLmdldEJ1ZmZlcigpLnBvc2l0aW9uRm9yQ2hhcmFjdGVySW5kZXgoZGF0YS5zdGFydCk7XG5cdFx0XHRcdFx0fSk7XG5cdFx0XHRcdH1cblxuXHRcdFx0fSxcblx0XHRcdGNvbmZpcm06IGZ1bmN0aW9uKCkge1xuXHRcdFx0XHRzZXRGaW5hbENhcmV0cyhzZWxDdHgsIGVkaXRvci5lZGl0b3IpO1xuXHRcdFx0fVxuXHRcdH0pO1xuXHR9XG59OyJdfQ==